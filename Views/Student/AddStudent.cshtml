@model AttendanceSystem.Models.Student

@{
    ViewData["Title"] = "Add Student";
}

<head>
    <style>
    #statusMessage {
        background: rgba(255, 255, 255, 0.05);
        padding: 12px 20px;
        border-radius: 8px;
        margin-bottom: 25px;
        font-size: 1rem;
        color: #fefefe;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .student-form {
        background: rgba(255, 255, 255, 0.05);
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        max-width: 500px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        color: #d1d5db;
    }

    input[type="text"] {
        width: 100%;
        padding: 10px 12px;
        border-radius: 6px;
        border: none;
        background-color: #1f1f1f;
        color: #f3f3f3;
        font-size: 1rem;
    }

    input[type="text"]:focus {
        outline: 2px solid #3b82f6;
        background-color: #1a1a1a;
    }

    

    .btn-submit {
        background-color: #16a34a;
        color: #fff;
        margin-top: 10px;
    }

    .btn-submit:hover {
        background-color: #15803d;
        transform: scale(1.03);
    }

    #serialConsole {
        background: #000;
        color: #00ff00;
        padding: 15px;
        font-family: monospace;
        font-size: 0.95rem;
        margin-top: 30px;
        border-radius: 8px;
        height: 200px;
        overflow-y: auto;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
    }
</style>

</head>

<h2>Add Student</h2>

<div id="statusMessage">🔌 Waiting for Arduino connection...</div>

<div id="studentForm" class="student-form" style="">
    <form method="post" action="@Url.Action("AddStudent", "Student")">
        <div class="form-group">
            <label for="name">Student Name:</label>
            <input type="text" id="name" name="name" required />
        </div>

        <div class="form-group">
            <label for="fingerprintId" id="fingerprintId">Fingerprint ID:</label>
            <div id="fingerprintIdForm">
            <input type="text" id="fingerprintIdInput" name="fingerprintId" readonly />
            <button type="button" class="btn btn-enroll" id="enrollButton">📲 Enroll</button>
            </div>
        </div>

        <button type="submit" class="btn add-btn"><i class="fa-solid fa-plus"></i> Add Student</button>
    </form>
</div>

<div id="serialConsole">
    <h3>🖥️ Serial Console</h3>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script>
        const studentForm = document.getElementById("studentForm");
        const statusMessage = document.getElementById("statusMessage");
        const fingerprintInput = document.getElementById("fingerprintId");

            const connection = new signalR.HubConnectionBuilder()
        .withUrl("/ArduinoHub") // <-- must match your `MapHub` route
        .build();


        // Initial check to see if Arduino is already connected
        fetch("/Student/IsArduinoConnected")
            .then(res => res.json())
            .then(data => {
                if (data.connected) {
                    studentForm.style.display = "block";
                    statusMessage.textContent = "✅ Fingerprint Sensor Connected!";
                } else {
                    //studentForm.style.display = "none";
                    statusMessage.textContent = "🔌 Waiting for Arduino connection...";
                }
            })
            .catch(err => console.error("❌ Error checking Arduino status:", err));

        // Enroll trigger
        document.getElementById("enrollButton").addEventListener("click", function () {
            fetch("/Student/TriggerEnrollment", { method: "POST" })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        alert("❌ Error: " + data.message);
                    }
                })
                .catch(err => console.error("❌ Error sending enroll command:", err));
        });

        // SignalR Events
        connection.on("ReceiveSerialLog", function (message) {
            console.log("📥 Serial Message:", message);

            if (message.includes("ArduinoFingerPrintSensorReady")) {
                studentForm.style.display = "block";
                statusMessage.textContent = "✅ Fingerprint Sensor Connected!";
            }

            if (message.startsWith("ID ") && /^\d+$/.test(message.substring(3))) {
                const fingerprintId = message.substring(3);
                fingerprintInput.value = fingerprintId;
                alert("✅ Fingerprint Enrolled! ID: " + fingerprintId);
            }

            const logDiv = document.getElementById("serialConsole");
            const logEntry = document.createElement("div");
            logEntry.textContent = message;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        });

        connection.start().catch(err => console.error("❌ SignalR Error:", err));

        connection.onclose(error => {
            console.error("🔌 SignalR connection closed:", error);
            statusMessage.textContent = "❌ Lost connection to Arduino.";
            studentForm.style.display = "none";
        });
    </script>
}
